name: ğŸ­ Wrap Image (Git Sync)

on:
  workflow_dispatch:
    inputs:
      base_image:
        description: 'åŸå§‹é•œåƒ (ä¾‹å¦‚: nginx:alpine, mysql:8.0, node:18)'
        required: true
        default: 'nginx:alpine'
      target_tag:
        description: 'ç›®æ ‡é•œåƒå (ä¾‹å¦‚: nginx-git-sync)'
        required: true
        default: 'app-git-sync'

jobs:
  build-push:
    runs-on: ubuntu-latest
    permissions:
      packages: write # å…è®¸å†™å…¥ GHCR
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. ä¾¦æ¢æ­¥éª¤ï¼šæ¢æµ‹åŸé•œåƒçš„ Entrypoint
      - name: ğŸ•µï¸ Detect Original Entrypoint
        id: detect
        run: |
          echo "Inspecting ${{ inputs.base_image }}..."
          docker pull ${{ inputs.base_image }}
          
          # æå– Entrypoint æ•°ç»„å¹¶å±•å¹³ä¸ºå­—ç¬¦ä¸²
          EP=$(docker inspect --format='{{range .Config.Entrypoint}}{{.}} {{end}}' ${{ inputs.base_image }})
          # å»é™¤å°¾éƒ¨ç©ºæ ¼
          EP=$(echo "$EP" | sed 's/ *$//')
          
          echo "Detected Entrypoint: [$EP]"
          echo "entrypoint=$EP" >> $GITHUB_OUTPUT

      # 2. å‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. ç™»å½• GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. æ„å»ºå¹¶æ¨é€
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          # åŒæ¶æ„æ”¯æŒ
          platforms: linux/amd64,linux/arm64
          # æ³¨å…¥å‚æ•°
          build-args: |
            BASE_IMAGE=${{ inputs.base_image }}
            ORIGINAL_ENTRYPOINT=${{ steps.detect.outputs.entrypoint }}
          # è‡ªåŠ¨æ‰“æ ‡ç­¾
          tags: ghcr.io/${{ github.repository_owner }}/${{ inputs.target_tag }}:latest
